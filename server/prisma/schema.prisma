// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Session {
  id           String        @id @default(uuid())
  createdAt    DateTime      @default(now())
  endedAt      DateTime?     // When session was ended
  pin          String        @default("000000") // Plain PIN for admin display
  pinHash      String        // Hashed PIN for verification
  status       String        @default("active") // active, ended
  participants Participant[]
  rounds       Round[]
  events       EventLog[]

  @@map("sessions")
}

model Participant {
  id         String    @id
  sessionId  String
  nickname   String
  runner     String
  model      String
  connected  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  lastSeen   DateTime  @default(now())
  session    Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  metrics    Metrics[]
  votes      Vote[]

  @@map("participants")
}

model Round {
  id            String    @id @default(uuid())
  sessionId     String
  index         Int
  prompt        String
  maxTokens     Int       @default(400)
  temperature   Float     @default(0.8)
  deadlineMs    Int       @default(90000)
  seed          Int?
  svgMode       Boolean   @default(false)
  startedAt     DateTime?
  endedAt       DateTime?
  votingStatus  String    @default("closed") // closed, open, revealed
  revealedCount Int       @default(0)        // number of positions revealed in award ceremony
  session       Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  metrics       Metrics[]
  votes         Vote[]

  @@unique([sessionId, index])
  @@map("rounds")
}

model Metrics {
  id                    String      @id @default(uuid())
  roundId               String
  participantId         String
  tokens                Int
  latencyFirstTokenMs   Int?
  durationMs            Int
  tpsAvg                Float?
  modelInfo             String?     // JSON string
  generatedContent      String?     // Full generated response
  createdAt             DateTime    @default(now())
  // New detailed timestamps for research
  generationStartedAt   DateTime?   // When participant started generating
  generationEndedAt     DateTime?   // When participant finished generating
  firstTokenAt          DateTime?   // When first token was received
  round                 Round       @relation(fields: [roundId], references: [id], onDelete: Cascade)
  participant           Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([roundId, participantId])
  @@map("metrics")
}

model Vote {
  id            String      @id @default(uuid())
  roundId       String
  voterHash     String
  participantId String
  score         Int
  createdAt     DateTime    @default(now())
  // New metrics for research
  voteOrder     Int?        // Order in which this vote was cast (1st, 2nd, etc. for this voter)
  responseTime  Int?        // Milliseconds from viewing response to voting
  userAgent     String?     // Browser/device info
  round         Round       @relation(fields: [roundId], references: [id], onDelete: Cascade)
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([roundId, voterHash, participantId])
  @@map("votes")
}

// New table for comprehensive event logging
model EventLog {
  id          String   @id @default(uuid())
  sessionId   String?
  timestamp   DateTime @default(now())
  eventType   String   // session_created, session_ended, round_created, round_started, round_stopped,
                       // voting_opened, voting_closed, reveal_started, position_revealed,
                       // participant_connected, participant_disconnected, vote_cast, etc.
  actorType   String   // admin, participant, voter, system
  actorId     String?  // participant_id, voter_hash, or null for admin/system
  targetType  String?  // session, round, participant, vote
  targetId    String?  // ID of the target entity
  metadata    String?  // JSON with additional context
  session     Session? @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([eventType])
  @@index([timestamp])
  @@map("event_logs")
}
